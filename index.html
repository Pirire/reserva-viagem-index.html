require('dotenv').config();
const express = require('express');
const cors = require('cors');
const Stripe = require('stripe');
const { MongoClient } = require('mongodb');
const nodemailer = require('nodemailer');
const bodyParser = require('body-parser');

const app = express();
const stripe = Stripe(process.env.STRIPE_SECRET_KEY);

// MongoDB
const client = new MongoClient(process.env.MONGODB_URI);
let reservasCollection;

app.use(cors({ origin: '*' }));
app.use(express.json());
app.use("/webhook", bodyParser.raw({ type: "application/json" }));

// Nodemailer
const transporter = nodemailer.createTransport({
  host: process.env.SMTP_HOST,
  port: parseInt(process.env.SMTP_PORT),
  secure: process.env.SMTP_SECURE === 'true',
  auth: {
    user: process.env.SMTP_USER,
    pass: process.env.SMTP_PASS
  }
});

// =====================
// Rota de teste de e-mail
// =====================
app.get("/teste-email", async (req, res) => {
  try {
    await transporter.sendMail({
      from: `"Reservas Viagem" <${process.env.SMTP_USER}>`,
      to: process.env.ADMIN_EMAIL,
      subject: "Teste de envio de e-mail",
      text: "E-mail de teste enviado com sucesso!"
    });
    res.send("E-mail de teste enviado com sucesso!");
  } catch (err) {
    console.error(err);
    res.status(500).send("Falha ao enviar e-mail: " + err.message);
  }
});

// =====================
// Rota de reservas sem pagamento
// =====================
app.post("/reservar-email", async (req, res) => {
  const { valor, nome, email, partida, destino, data, codigo } = req.body;

  try {
    await reservasCollection.insertOne({ valor, nome, email, partida, destino, data, codigo, pago: false });

    await transporter.sendMail({
      from: `"Reservas Viagem" <${process.env.SMTP_USER}>`,
      to: process.env.ADMIN_EMAIL,
      subject: "Nova Reserva (sem pagamento)",
      html: `
        <h2>Nova Reserva Recebida</h2>
        <p><strong>Nome:</strong> ${nome}</p>
        <p><strong>Email:</strong> ${email}</p>
        <p><strong>Partida:</strong> ${partida}</p>
        <p><strong>Destino:</strong> ${destino}</p>
        <p><strong>Data:</strong> ${data}</p>
        <p><strong>Valor:</strong> ${valor} ‚Ç¨</p>
        <p><strong>C√≥digo:</strong> ${codigo}</p>
      `
    });

    res.json({ mensagem: "Reserva registada (sem pagamento). Admin notificado." });
  } catch (err) {
    console.error(err);
    res.status(500).json({ error: "Erro ao criar reserva sem pagamento" });
  }
});

// =====================
// Rota de pagamento (Stripe Checkout)
// =====================
app.post("/checkout", async (req, res) => {
  try {
    const { valor, nome, email, partida, destino, data, codigo } = req.body;

    const session = await stripe.checkout.sessions.create({
      payment_method_types: ["card"],
      mode: "payment",
      customer_email: email,
      line_items: [{
        price_data: {
          currency: "eur",
          product_data: { name: `Viagem de ${partida} at√© ${destino}` },
          unit_amount: Math.round(parseFloat(valor) * 100)
        },
        quantity: 1
      }],
      success_url: `${process.env.FRONTEND_URL}?success=true`,
      cancel_url: `${process.env.FRONTEND_URL}?canceled=true`,
      metadata: { nome, email, partida, destino, data, codigo }
    });

    await reservasCollection.insertOne({ valor, nome, email, partida, destino, data, codigo, pago: false });

    res.json({ url: session.url });
  } catch (err) {
    console.error(err);
    res.status(500).send("Erro ao criar checkout: " + err.message);
  }
});

// =====================
// Webhook Stripe
// =====================
app.post("/webhook", async (req, res) => {
  const sig = req.headers["stripe-signature"];
  let event;

  try {
    event = stripe.webhooks.constructEvent(req.body, sig, process.env.STRIPE_WEBHOOK_SECRET);
  } catch (err) {
    console.error("‚ùå Erro no webhook:", err.message);
    return res.status(400).send(`Webhook Error: ${err.message}`);
  }

  if (event.type === "checkout.session.completed") {
    const session = event.data.object;
    const { nome, email, partida, destino, data, codigo } = session.metadata;
    const valor = (session.amount_total / 100).toFixed(2);

    await reservasCollection.updateOne({ codigo }, { $set: { pago: true } });

    const conteudo = `
      <h2>Reserva Confirmada e Paga</h2>
      <p><strong>Nome:</strong> ${nome}</p>
      <p><strong>Email:</strong> ${email}</p>
      <p><strong>Partida:</strong> ${partida}</p>
      <p><strong>Destino:</strong> ${destino}</p>
      <p><strong>Data:</strong> ${data}</p>
      <p><strong>Valor pago:</strong> ${valor} ‚Ç¨</p>
      <p><strong>C√≥digo:</strong> ${codigo}</p>
    `;

    // Email para cliente
    await transporter.sendMail({
      from: `"Reservas Viagem" <${process.env.SMTP_USER}>`,
      to: email,
      subject: "Pagamento Confirmado - Sua Reserva",
      html: conteudo
    });

    // Email para admin
    await transporter.sendMail({
      from: `"Reservas Viagem" <${process.env.SMTP_USER}>`,
      to: process.env.ADMIN_EMAIL,
      subject: `Reserva Paga - ${nome}`,
      html: conteudo
    });

    console.log("‚úÖ E-mails enviados ap√≥s pagamento confirmado.");
  }

  res.json({ received: true });
});

// =====================
// Ver todas as reservas
// =====================
app.get("/ver-reservas", async (req, res) => {
  try {
    const reservas = await reservasCollection.find().toArray();
    res.json(reservas);
  } catch (err) {
    console.error("‚ùå Erro ao consultar reservas:", err.message);
    res.status(500).json({ error: "N√£o foi poss√≠vel consultar as reservas." });
  }
});

// Conectar ao MongoDB e iniciar servidor
async function startServer() {
  try {
    await client.connect();
    const db = client.db();
    reservasCollection = db.collection("reservas");
    console.log("‚úÖ Conectado ao MongoDB!");

    const PORT = process.env.PORT || 4000;
    app.listen(PORT, () => console.log(`üöÄ Servidor rodando na porta ${PORT}`));
  } catch (err) {
    console.error("‚ùå Falha ao conectar ao MongoDB:", err);
    process.exit(1);
  }
}

startServer();
